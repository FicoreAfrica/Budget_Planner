<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ translations['Financial Health Score'] }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-step { display: none; }
        .form-step.active { display: block; }
        .invalid-feedback { display: none; }
        .form-control.is-invalid ~ .invalid-feedback,
        .form-select.is-invalid ~ .invalid-feedback { display: block; }
        .progress { height: 30px; }
        .progress-bar { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">{{ translations['Financial Health Score'] }}</h1>
        <div class="progress mb-4">
            <div class="progress-bar" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100">Step 1</div>
        </div>
        <form id="submission-form" method="POST" action="{{ url_for('health_score_form') }}">
            {{ form.hidden_tag() }}

            <!-- Step 1: Personal Details -->
            <div class="form-step active" id="step-1">
                <h2>{{ translations['Personal Details'] }}</h2>
                <div class="form-group mb-3">
                    <label for="first_name" class="form-label">{{ translations['First Name'] }}</label>
                    <input type="text" class="form-control" id="first_name" name="first_name" required aria-required="true" value="{{ form.first_name.data or '' }}">
                    <div class="invalid-feedback">{{ translations['First name is required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="last_name" class="form-label">{{ translations['Last Name'] }}</label>
                    <input type="text" class="form-control" id="last_name" name="last_name" required aria-required="true" value="{{ form.last_name.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Last name is required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="email" class="form-label">{{ translations['Email'] }}</label>
                    <input type="email" class="form-control" id="email" name="email" required aria-required="true" value="{{ form.email.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Valid email is required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="confirm_email" class="form-label">{{ translations['Confirm Email'] }}</label>
                    <input type="email" class="form-control" id="confirm_email" name="confirm_email" required aria-required="true" value="{{ form.confirm_email.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Emails must match'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="phone" class="form-label">{{ translations['Phone Number'] }}</label>
                    <input type="tel" class="form-control" id="phone" name="phone" required aria-required="true" value="{{ form.phone.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Valid phone number is required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="language" class="form-label">{{ translations['Language'] }}</label>
                    <select class="form-select" id="language" name="language" required aria-required="true">
                        <option value="English" {% if form.language.data == 'English' %}selected{% endif %}>{{ translations['language_option_en'] }}</option>
                        <option value="Hausa" {% if form.language.data == 'Hausa' %}selected{% endif %}>{{ translations['language_option_ha'] }}</option>
                    </select>
                    <div class="invalid-feedback">{{ translations['Language is required'] }}</div>
                </div>
                <button type="button" class="btn btn-primary next-step">{{ translations['Next'] }}</button>
            </div>

            <!-- Step 2: Business Details -->
            <div class="form-step" id="step-2">
                <h2>{{ translations['Business Details'] }}</h2>
                <div class="form-group mb-3">
                    <label for="business_name" class="form-label">{{ translations['Business Name'] }}</label>
                    <input type="text" class="form-control" id="business_name" name="business_name" required aria-required="true" value="{{ form.business_name.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Business name is required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="user_type" class="form-label">{{ translations['User Type'] }}</label>
                    <select class="form-select" id="user_type" name="user_type" required aria-required="true">
                        <option value="Individual" {% if form.user_type.data == 'Individual' %}selected{% endif %}>{{ translations['user_type_individual'] }}</option>
                        <option value="Business" {% if form.user_type.data == 'Business' %}selected{% endif %}>{{ translations['user_type_business'] }}</option>
                    </select>
                    <div class="invalid-feedback">{{ translations['User type is required'] }}</div>
                </div>
                <button type="button" class="btn btn-secondary prev-step">{{ translations['Previous'] }}</button>
                <button type="button" class="btn btn-primary next-step">{{ translations['Next'] }}</button>
            </div>

            <!-- Step 3: Financial Data -->
            <div class="form-step" id="step-3">
                <h2>{{ translations['Financial Data'] }}</h2>
                <div class="form-group mb-3">
                    <label for="income" class="form-label">{{ translations['Monthly Income'] }}</label>
                    <input type="number" class="form-control" id="income" name="income" required aria-required="true" min="0" step="0.01" value="{{ form.income.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Valid income is required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="expenses" class="form-label">{{ translations['Monthly Expenses'] }}</label>
                    <input type="number" class="form-control" id="expenses" name="expenses" required aria-required="true" min="0" step="0.01" value="{{ form.expenses.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Valid expenses are required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="debt" class="form-label">{{ translations['Total Debt'] }}</label>
                    <input type="number" class="form-control" id="debt" name="debt" required aria-required="true" min="0" step="0.01" value="{{ form.debt.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Valid debt amount is required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="interest_rate" class="form-label">{{ translations['Debt Interest Rate'] }}</label>
                    <input type="number" class="form-control" id="interest_rate" name="interest_rate" required aria-required="true" min="0" max="100" step="0.01" value="{{ form.interest_rate.data or '' }}">
                    <div class="invalid-feedback">{{ translations['Valid interest rate is required'] }}</div>
                </div>
                <div class="form-group mb-3">
                    <label for="auto_email" class="form-label">{{ translations['auto_email_label'] }}</label>
                    <input type="checkbox" class="form-check-input" id="auto_email" name="auto_email" {% if form.auto_email.data %}checked{% endif %}>
                    <div class="valid-feedback">{{ translations['auto_email_valid'] }}</div>
                </div>
                <button type="button" class="btn btn-secondary prev-step">{{ translations['Previous'] }}</button>
                <button type="submit" class="btn btn-success">{{ translations['Submit'] }}</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.getElementById('submission-form');
        const steps = document.querySelectorAll('.form-step');
        const nextButtons = document.querySelectorAll('.next-step');
        const prevButtons = document.querySelectorAll('.prev-step');
        const progressBar = document.querySelector('.progress-bar');
        let currentStep = 0;

        function updateStep(step) {
            steps.forEach((s, index) => {
                s.classList.toggle('active', index === step);
            });
            const progress = (step + 1) / steps.length * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `Step ${step + 1}`;
            progressBar.setAttribute('aria-valuenow', progress);
        }

        function validateStep(step) {
            const inputs = steps[step].querySelectorAll('input[required], select[required]');
            let isValid = true;
            inputs.forEach(input => {
                input.classList.remove('is-invalid');
                if (!input.checkValidity()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                }
                if (input.type === 'email' && input.id === 'confirm_email') {
                    const email = document.getElementById('email').value;
                    if (input.value !== email) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    }
                }
                if (input.type === 'number') {
                    const value = parseFloat(input.value);
                    if (input.min && value < parseFloat(input.min)) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    }
                    if (input.max && value > parseFloat(input.max)) {
                        input.classList.add('is-invalid');
                        isValid = false;
                    }
                }
            });
            if (!isValid) {
                const firstInvalid = steps[step].querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
            }
            return isValid;
        }

        nextButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    currentStep++;
                    if (currentStep < steps.length) {
                        updateStep(currentStep);
                    }
                }
            });
        });

        prevButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentStep--;
                updateStep(currentStep);
            });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (validateStep(currentStep)) {
                try {
                    form.submit();
                } catch (error) {
                    console.error('Submission error:', error);
                    alert('{{ translations["Submission failed. Please try again."] }}');
                }
            }
        });

        // Real-time validation
        form.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', () => {
                if (input.checkValidity()) {
                    input.classList.remove('is-invalid');
                } else {
                    input.classList.add('is-invalid');
                }
                if (input.id === 'confirm_email') {
                    const email = document.getElementById('email').value;
                    if (input.value !== email) {
                        input.classList.add('is-invalid');
                    }
                }
            });
        });
    </script>
</body>
</html>