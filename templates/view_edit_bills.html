{% extends 'base.html' %}
{% block title %}{{ trans('bill_view_edit_bills') | default('View and Edit Bills') }}{% endblock %}
{% block content %}
<div class="container">
    {% set tool_name = 'bill_view_edit_bills' | default('View and Edit Bills') %}
    {% set tool_icon = 'fa-file-invoice' %}
    {% set subtitle = 'Let’s start with a few details' %}
    {% include 'tool_header.html' %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ trans('bill_' + message) | default(message) | safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ trans('core_close') | default('Close') }}"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <div class="mb-3">
        <label class="form-label">{{ trans('bill_select_category') | default('Select Category') }}</label>
        <select class="form-select" onchange="window.location.href='{{ url_for('bill.view_edit') }}?category='+this.value">
            <option value="all" {% if category == 'all' %}selected{% endif %}>{{ trans('core_all') | default('All') }}</option>
            {% for cat, cat_label in form.category.choices %}
                <option value="{{ cat }}" {% if category == cat %}selected{% endif %}>{{ trans('bill_category_' + cat) | default(cat_label) }}</option>
            {% endfor %}
        </select>
    </div>
    {% if bills %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>{{ trans('bill_bill_name') | default('Bill Name') }}</th>
                        <th>{{ trans('bill_amount') | default('Amount') }}</th>
                        <th>{{ trans('bill_due_date') | default('Due Date') }}</th>
                        <th>{{ trans('bill_status') | default('Status') }}</th>
                        <th>{{ trans('bill_edit') | default('Edit') }}</th>
                        <th>{{ trans('bill_delete') | default('Delete') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill_id, bill in bills %}
                        <tr>
                            <td>{{ bill.bill_name }}</td>
                            <td>₦{{ bill.amount | format_number }}</td>
                            <td>{{ trans('bill_due') | default('Due') }} {{ bill.due_date }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('bill.view_edit') }}" style="display:inline;">
                                    <input type="hidden" name="bill_id" value="{{ bill_id }}">
                                    <input type="hidden" name="action" value="toggle_status">
                                    <button type="submit" class="btn btn-link status-{{ 'paid' if bill.status == 'paid' else 'unpaid' }}">
                                        {{ trans('bill_status_' + bill.status) | default(bill.status|capitalize) }}
                                    </button>
                                </form>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal-{{ bill_id }}">{{ trans('bill_edit') | default('Edit') }}</button>
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('bill.view_edit') }}" onsubmit="return confirm('{{ trans('bill_confirm_delete_prompt') | default('Are you sure you want to delete this bill?') }}');">
                                    <input type="hidden" name="bill_id" value="{{ bill_id }}">
                                    <input type="hidden" name="action" value="delete">
                                    <button type="submit" class="btn btn-danger btn-sm">{{ trans('bill_delete') | default('Delete') }}</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% for bill_id, bill in bills %}
            <div class="modal fade" id="editModal-{{ bill_id }}" tabindex="-1" aria-labelledby="editModalLabel-{{ bill_id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editModalLabel-{{ bill_id }}">{{ trans('bill_edit') | default('Edit') }} {{ bill.bill_name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ trans('core_close') | default('Close') }}"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST" action="{{ url_for('bill.view_edit') }}">
                                {{ form.csrf_token }}
                                <input type="hidden" name="bill_id" value="{{ bill_id }}">
                                <input type="hidden" name="action" value="edit">
                                <div class="mb-3">
                                    <label class="form-label">{{ trans('bill_bill_name') | default('Bill Name') }}</label>
                                    {{ form.bill_name(class="form-control", value=bill.bill_name) }}
                                    <div class="invalid-feedback">{{ trans('bill_bill_name_required') | default('Bill name is required') }}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ trans('bill_amount') | default('Amount') }}</label>
                                    {{ form.amount(class="form-control", id="editAmountInput-{{ bill_id }}", value=bill.amount) }}
                                    <div class="invalid-feedback">{{ trans('bill_amount_required') | default('Valid amount is required') }}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ trans('bill_due_date') | default('Due Date') }}</label>
                                    {{ form.due_date(class="form-control", type="date", value=bill.due_date) }}
                                    <div class="invalid-feedback">{{ trans('bill_due_date_required') | default('Valid due date is required') }}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ trans('bill_category') | default('Category') }}</label>
                                    {{ form.category(class="form-select", value=bill.category) }}
                                    <div class="invalid-feedback">{{ trans('bill_category_required') | default('Category is required') }}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ trans('bill_frequency') | default('Frequency') }}</label>
                                    {{ form.frequency(class="form-select", value=bill.frequency) }}
                                    <div class="invalid-feedback">{{ trans('bill_frequency_required') | default('Frequency is required') }}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ trans('bill_status') | default('Status') }}</label>
                                    {{ form.status(class="form-select", value=bill.status) }}
                                    <div class="invalid-feedback">{{ trans('bill_status_required') | default('Status is required') }}</div>
                                </div>
                                <button type="submit" class="btn btn-primary">{{ trans('bill_save_bill') | default('Save Bill') }}</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="card">
            <div class="card-body">
                <p>{{ trans('bill_no_bills_empty_state') | default('No bills added yet. Start by adding one!') }}</p>
                <a href="{{ url_for('bill.form') }}" class="btn btn-primary">{{ trans('bill_add_another_bill') | default('Add Bill') }}</a>
            </div>
        </div>
    {% endif %}
    <div class="mt-3 d-flex justify-content-between">
        <a href="{{ url_for('bill.form') }}" class="btn btn-primary">{{ trans('bill_add_another_bill') | default('Add Bill') }}</a>
        <a href="{{ url_for('bill.dashboard') }}" class="btn btn-primary">{{ trans('bill_go_to_dashboard') | default('Go to Dashboard') }}</a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">{{ trans('bill_back_to_index') | default('Back to Index') }}</a>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
    // Format amount field (commas) as user types in edit form
    function formatNumberInput(input) {
        const format = (val) => {
            let clean = val.replace(/[^0-9.]/g, '');
            if (!clean) return '';
            let parts = clean.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        };

        input.addEventListener('input', function(e) {
            let cursor = input.selectionStart;
            let oldLength = input.value.length;
            input.value = format(input.value);
            let newLength = input.value.length;
            input.setSelectionRange(cursor + (newLength - oldLength), cursor + (newLength - oldLength));
        });
    }

    // Strip commas before submitting the edit form
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[id^="editAmountInput-"]').forEach(function(amt) {
            if (amt) formatNumberInput(amt);
        });

        document.querySelectorAll('form[action="{{ url_for('bill.view_edit') }}"]').forEach(function(form) {
            form.addEventListener('submit', function() {
                var ea = form.querySelector('[id^="editAmountInput-"]');
                if (ea) ea.value = ea.value.replace(/,/g, '');
            });
        });
    });
</script>
{% endblock %}
